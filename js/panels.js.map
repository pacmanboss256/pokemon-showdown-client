{"version":3,"sources":["../src/panels.tsx"],"names":["PSRouter","roomid","panelState","currentRoomid","location","pathname","slice","test","subscribeHistory","endsWith","subscribeHash","extractRoomID","url","startsWith","document","origin","length","host","PS","server","id","replace","redirects","hash","join","subscribeAndRun","room","window","addEventListener","e","possibleRoomid","history","leftRoomWidth","leftRoom","rightRoom","pushState","title","replaceState","state","split","leftRoomid","rightRoomid","router","PSRoomPanel","subscriptions","componentDidMount","props","focus","onParentEvent","push","subscribe","args","forceUpdate","receiveLine","base","setDimensions","offsetWidth","offsetHeight","componentDidUpdate","includes","componentWillUnmount","subscription","unsubscribe","chooseParentValue","value","dropdownButton","parentElem","changeEvent","Event","dispatchEvent","closePopup","render","preact","Component","PSPanelWrapper","children","style","PSMain","getPopupStyle","width","posStyle","scrollable","elem","target","className","preventDefault","stopImmediatePropagation","clickedRoom","name","getAttribute","userid","toID","addRoom","parentRoomid","containingRoomid","rightPopup","username","update","tagName","href","getRoom","leave","handleButtonClick","rooms","parentElement","popups","isTextInput","type","modifierKey","ctrlKey","altKey","metaKey","shiftKey","keyCode","arrowKeysUsed","focusLeftRoom","focusRightRoom","prefs","key","body","dark","curElem","mainmenu","send","isEmptyClick","selection","getSelection","err","BattleTooltips","hideTooltip","pos","activePanel","top","right","left","display","height","bottom","RangeError","position","visibility","margin","offset","getBoundingClientRect","sourceWidth","sourceHeight","availableHeight","documentElement","clientHeight","Math","max","offsetLeft","clientWidth","availableWidth","maxWidth","renderRoom","roomType","roomTypes","Panel","renderPopup","map","SanitizedHTML","__html","BattleLog","sanitizeHTML"],"mappings":"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","sourcesContent":["/**\r\n * Panels\r\n *\r\n * Main view - sets up the frame, and the generic panels.\r\n *\r\n * Also sets up most global event listeners.\r\n *\r\n * @author Guangcong Luo <guangcongluo@gmail.com>\r\n * @license AGPLv3\r\n */\r\n\r\nclass PSRouter {\r\n\troomid = '' as RoomID;\r\n\tpanelState = '';\r\n\tconstructor() {\r\n\t\tconst currentRoomid = location.pathname.slice(1);\r\n\t\tif (/^[a-z0-9-]+$/.test(currentRoomid)) {\r\n\t\t\tthis.subscribeHistory();\r\n\t\t} else if (location.pathname.endsWith('.html')) {\r\n\t\t\tthis.subscribeHash();\r\n\t\t}\r\n\t}\r\n\textractRoomID(url: string) {\r\n\t\tif (url.startsWith(document.location.origin)) {\r\n\t\t\turl = url.slice(document.location.origin.length);\r\n\t\t} else {\r\n\t\t\tif (url.startsWith('http://')) {\r\n\t\t\t\turl = url.slice(7);\r\n\t\t\t} else if (url.startsWith('https://')) {\r\n\t\t\t\turl = url.slice(8);\r\n\t\t\t}\r\n\t\t\tif (url.startsWith(document.location.host)) {\r\n\t\t\t\turl = url.slice(document.location.host.length);\r\n\t\t\t} else if (PS.server.id === 'showdown' && url.startsWith('play.pokemonshowdown.com')) {\r\n\t\t\t\turl = url.slice(24);\r\n\t\t\t} else if (PS.server.id === 'showdown' && url.startsWith('psim.us')) {\r\n\t\t\t\turl = url.slice(7);\r\n\t\t\t} else if (url.startsWith('replay.pokemonshowdown.com')) {\r\n\t\t\t\turl = url.slice(26).replace('/', '/battle-');\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (url.startsWith('/')) url = url.slice(1);\r\n\r\n\t\tif (!/^[a-z0-9-]*$/.test(url)) return null;\r\n\r\n\t\tconst redirects = /^(appeals?|rooms?suggestions?|suggestions?|adminrequests?|bugs?|bugreports?|rules?|faq|credits?|privacy|contact|dex|insecure)$/;\r\n\t\tif (redirects.test(url)) return null;\r\n\r\n\t\treturn url as RoomID;\r\n\t}\r\n\tsubscribeHash() {\r\n\t\tif (location.hash) {\r\n\t\t\tconst currentRoomid = location.hash.slice(1);\r\n\t\t\tif (/^[a-z0-9-]+$/.test(currentRoomid)) {\r\n\t\t\t\tPS.join(currentRoomid as RoomID);\r\n\t\t\t} else {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t}\r\n\t\tPS.subscribeAndRun(() => {\r\n\t\t\tconst roomid = PS.room.id;\r\n\t\t\tlocation.hash = roomid ? '#' + roomid : '';\r\n\t\t});\r\n\t\twindow.addEventListener('hashchange', e => {\r\n\t\t\tconst possibleRoomid = location.hash.slice(1);\r\n\t\t\tlet currentRoomid: RoomID | null = null;\r\n\t\t\tif (/^[a-z0-9-]*$/.test(possibleRoomid)) {\r\n\t\t\t\tcurrentRoomid = possibleRoomid as RoomID;\r\n\t\t\t}\r\n\t\t\tif (currentRoomid !== null) {\r\n\t\t\t\tPS.join(currentRoomid);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\tsubscribeHistory() {\r\n\t\tconst currentRoomid = location.pathname.slice(1);\r\n\t\tif (/^[a-z0-9-]+$/.test(currentRoomid)) {\r\n\t\t\tPS.join(currentRoomid as RoomID);\r\n\t\t} else {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (!window.history) return;\r\n\t\tPS.subscribeAndRun(() => {\r\n\t\t\tconst room = PS.room;\r\n\t\t\tconst roomid = room.id;\r\n\t\t\tconst panelState = (PS.leftRoomWidth ?\r\n\t\t\t\tPS.leftRoom.id + '..' + PS.rightRoom!.id :\r\n\t\t\t\troomid);\r\n\t\t\tif (roomid === this.roomid && panelState === this.panelState) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tif (panelState === this.panelState) {\r\n\t\t\t\thistory.pushState(panelState, room.title, '/' + roomid);\r\n\t\t\t} else {\r\n\t\t\t\thistory.replaceState(panelState, room.title, '/' + roomid);\r\n\t\t\t}\r\n\t\t\tthis.roomid = roomid;\r\n\t\t\tthis.panelState = panelState;\r\n\t\t});\r\n\t\twindow.addEventListener('popstate', e => {\r\n\t\t\tconst possibleRoomid = location.pathname.slice(1);\r\n\t\t\tlet roomid: RoomID | null = null;\r\n\t\t\tif (/^[a-z0-9-]*$/.test(possibleRoomid)) {\r\n\t\t\t\troomid = possibleRoomid as RoomID;\r\n\t\t\t}\r\n\t\t\tif (typeof e.state === 'string') {\r\n\t\t\t\tconst [leftRoomid, rightRoomid] = e.state.split('..') as RoomID[];\r\n\t\t\t\tPS.join(leftRoomid, 'left');\r\n\t\t\t\tif (rightRoomid) {\r\n\t\t\t\t\tPS.join(rightRoomid, 'right');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (roomid !== null) {\r\n\t\t\t\tPS.join(roomid);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\nPS.router = new PSRouter();\r\n\r\nclass PSRoomPanel<T extends PSRoom = PSRoom> extends preact.Component<{room: T}> {\r\n\tsubscriptions: PSSubscription[] = [];\r\n\tcomponentDidMount() {\r\n\t\tif (PS.room === this.props.room) this.focus();\r\n\t\tthis.props.room.onParentEvent = (id: string, e?: Event) => {\r\n\t\t\tif (id === 'focus') this.focus();\r\n\t\t};\r\n\t\tthis.subscriptions.push(this.props.room.subscribe(args => {\r\n\t\t\tif (!args) this.forceUpdate();\r\n\t\t\telse this.receiveLine(args);\r\n\t\t}));\r\n\t\tif (this.base) {\r\n\t\t\tthis.props.room.setDimensions(this.base.offsetWidth, this.base.offsetHeight);\r\n\t\t}\r\n\t}\r\n\tcomponentDidUpdate() {\r\n\t\tif (this.base && ['popup', 'semimodal-popup'].includes(this.props.room.location)) {\r\n\t\t\tthis.props.room.setDimensions(this.base.offsetWidth, this.base.offsetHeight);\r\n\t\t}\r\n\t}\r\n\tcomponentWillUnmount() {\r\n\t\tthis.props.room.onParentEvent = null;\r\n\t\tfor (const subscription of this.subscriptions) {\r\n\t\t\tsubscription.unsubscribe();\r\n\t\t}\r\n\t\tthis.subscriptions = [];\r\n\t}\r\n\treceiveLine(args: Args) {}\r\n\t/**\r\n\t * PS has \"fake select menus\", buttons that act like <select> dropdowns.\r\n\t * This function is used by the popups they open to change the button\r\n\t * values.\r\n\t */\r\n\tchooseParentValue(value: string) {\r\n\t\tconst dropdownButton = this.props.room.parentElem as HTMLButtonElement;\r\n\t\tdropdownButton.value = value;\r\n\t\tconst changeEvent = new Event('change');\r\n\t\tdropdownButton.dispatchEvent(changeEvent);\r\n\t\tPS.closePopup();\r\n\t}\r\n\tfocus() {}\r\n\trender() {\r\n\t\treturn <PSPanelWrapper room={this.props.room}>\r\n\t\t\t<div class=\"mainmessage\"><p>Loading...</p></div>\r\n\t\t</PSPanelWrapper>;\r\n\t}\r\n}\r\n\r\nfunction PSPanelWrapper(props: {\r\n\troom: PSRoom, children: preact.ComponentChildren, scrollable?: boolean, width?: number | 'auto',\r\n}) {\r\n\tconst room = props.room;\r\n\tif (room.location === 'mini-window') {\r\n\t\tif (room.id === 'news') {\r\n\t\t\treturn <div>{props.children}</div>;\r\n\t\t}\r\n\t\treturn <div id={`room-${room.id}`} class=\"mini-window-contents ps-room-light\">{props.children}</div>;\r\n\t}\r\n\tif (room.location !== 'left' && room.location !== 'right') {\r\n\t\tconst style = PSMain.getPopupStyle(room, props.width);\r\n\t\treturn <div class=\"ps-popup\" id={`room-${room.id}`} style={style}>\r\n\t\t\t{props.children}\r\n\t\t</div>;\r\n\t}\r\n\tconst style = PSMain.posStyle(room);\r\n\treturn <div\r\n\t\tclass={'ps-room' + (room.id === '' ? '' : ' ps-room-light') + (props.scrollable ? ' scrollable' : '')}\r\n\t\tid={`room-${room.id}`}\r\n\t\tstyle={style}\r\n\t>\r\n\t\t{props.children}\r\n\t</div>;\r\n}\r\n\r\nclass PSMain extends preact.Component {\r\n\tconstructor() {\r\n\t\tsuper();\r\n\t\tPS.subscribe(() => this.forceUpdate());\r\n\r\n\t\twindow.addEventListener('click', e => {\r\n\t\t\tlet elem = e.target as HTMLElement | null;\r\n\t\t\tif (elem?.className === 'ps-overlay') {\r\n\t\t\t\tPS.closePopup();\r\n\t\t\t\te.preventDefault();\r\n\t\t\t\te.stopImmediatePropagation();\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tlet clickedRoom = null;\r\n\t\t\twhile (elem) {\r\n\t\t\t\tif (` ${elem.className} `.includes(' username ')) {\r\n\t\t\t\t\tconst name = elem.getAttribute('data-name');\r\n\t\t\t\t\tconst userid = toID(name);\r\n\t\t\t\t\tconst roomid = `user-${userid}` as RoomID;\r\n\t\t\t\t\tPS.addRoom({\r\n\t\t\t\t\t\tid: roomid,\r\n\t\t\t\t\t\tparentElem: elem,\r\n\t\t\t\t\t\tparentRoomid: PSMain.containingRoomid(elem),\r\n\t\t\t\t\t\trightPopup: elem.className === 'userbutton username',\r\n\t\t\t\t\t\tusername: name,\r\n\t\t\t\t\t});\r\n\t\t\t\t\tPS.update();\r\n\t\t\t\t\te.preventDefault();\r\n\t\t\t\t\te.stopImmediatePropagation();\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tif (elem.tagName === 'A' || elem.getAttribute('data-href')) {\r\n\t\t\t\t\tconst href = elem.getAttribute('data-href') || (elem as HTMLAnchorElement).href;\r\n\t\t\t\t\tconst roomid = PS.router.extractRoomID(href);\r\n\r\n\t\t\t\t\tif (roomid !== null) {\r\n\t\t\t\t\t\tif (elem.getAttribute('data-target') === 'replace') {\r\n\t\t\t\t\t\t\tconst room = this.getRoom(elem);\r\n\t\t\t\t\t\t\tif (room) PS.leave(room.id);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tPS.addRoom({\r\n\t\t\t\t\t\t\tid: roomid,\r\n\t\t\t\t\t\t\tparentElem: elem,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tPS.update();\r\n\t\t\t\t\t\te.preventDefault();\r\n\t\t\t\t\t\te.stopImmediatePropagation();\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tif (elem.tagName === 'BUTTON') {\r\n\t\t\t\t\tif (this.handleButtonClick(elem as HTMLButtonElement)) {\r\n\t\t\t\t\t\te.preventDefault();\r\n\t\t\t\t\t\te.stopImmediatePropagation();\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t} else if (!elem.getAttribute('type')) {\r\n\t\t\t\t\t\t// the spec says that buttons with no `type` attribute should be\r\n\t\t\t\t\t\t// submit buttons, but this is a bad default so we're going\r\n\t\t\t\t\t\t// to just assume they're not\r\n\r\n\t\t\t\t\t\t// don't return, to allow <a><button> to make links that look\r\n\t\t\t\t\t\t// like buttons\r\n\t\t\t\t\t\te.preventDefault();\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t// presumably a different part of the app is handling this button\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (elem.id.startsWith('room-')) {\r\n\t\t\t\t\tclickedRoom = PS.rooms[elem.id.slice(5)];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\telem = elem.parentElement;\r\n\t\t\t}\r\n\t\t\tif (PS.room !== clickedRoom) {\r\n\t\t\t\tif (clickedRoom) PS.room = clickedRoom;\r\n\t\t\t\twhile (PS.popups.length && (!clickedRoom || clickedRoom.id !== PS.popups[PS.popups.length - 1])) {\r\n\t\t\t\t\tPS.closePopup();\r\n\t\t\t\t}\r\n\t\t\t\tPS.update();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\twindow.addEventListener('keydown', e => {\r\n\t\t\tlet elem = e.target as HTMLInputElement | null;\r\n\t\t\tif (elem) {\r\n\t\t\t\tlet isTextInput = (elem.tagName === 'INPUT' || elem.tagName === 'TEXTAREA');\r\n\t\t\t\tif (isTextInput && ['button', 'radio', 'checkbox', 'file'].includes(elem.type)) {\r\n\t\t\t\t\tisTextInput = false;\r\n\t\t\t\t}\r\n\t\t\t\tif (isTextInput && elem.value) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (PS.room.onParentEvent) {\r\n\t\t\t\tif (PS.room.onParentEvent('keydown', e) === false) {\r\n\t\t\t\t\te.stopImmediatePropagation();\r\n\t\t\t\t\te.preventDefault();\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tlet modifierKey = e.ctrlKey || e.altKey || e.metaKey || e.shiftKey;\r\n\t\t\tif (modifierKey) return;\r\n\t\t\tif (e.keyCode === 37) { // left\r\n\t\t\t\tPS.arrowKeysUsed = true;\r\n\t\t\t\tPS.focusLeftRoom();\r\n\t\t\t} else if (e.keyCode === 39) { // right\r\n\t\t\t\tPS.arrowKeysUsed = true;\r\n\t\t\t\tPS.focusRightRoom();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tPS.prefs.subscribeAndRun(key => {\r\n\t\t\tif (!key || key === 'dark') {\r\n\t\t\t\tdocument.body.className = PS.prefs.dark ? 'dark' : '';\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\tgetRoom(elem: HTMLElement) {\r\n\t\tlet curElem: HTMLElement | null = elem;\r\n\t\twhile (curElem) {\r\n\t\t\tif (curElem.id.startsWith('room-')) {\r\n\t\t\t\treturn PS.rooms[curElem.id.slice(5)];\r\n\t\t\t}\r\n\t\t\tcurElem = curElem.parentElement;\r\n\t\t}\r\n\t}\r\n\thandleButtonClick(elem: HTMLButtonElement) {\r\n\t\tswitch (elem.name) {\r\n\t\tcase 'closeRoom':\r\n\t\t\tPS.leave(elem.value as RoomID);\r\n\t\t\treturn true;\r\n\t\tcase 'joinRoom':\r\n\t\t\tPS.addRoom({\r\n\t\t\t\tid: elem.value as RoomID,\r\n\t\t\t\tparentElem: elem,\r\n\t\t\t});\r\n\t\t\tPS.update();\r\n\t\t\treturn true;\r\n\t\tcase 'send':\r\n\t\tcase 'cmd':\r\n\t\t\tconst room = this.getRoom(elem) || PS.mainmenu;\r\n\t\t\troom.send(elem.value, elem.name === 'send');\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\tstatic containingRoomid(elem: HTMLElement) {\r\n\t\tlet curElem: HTMLElement | null = elem;\r\n\t\twhile (curElem) {\r\n\t\t\tif (curElem.id.startsWith('room-')) {\r\n\t\t\t\treturn curElem.id.slice(5) as RoomID;\r\n\t\t\t}\r\n\t\t\tcurElem = curElem.parentElement;\r\n\t\t}\r\n\t\treturn null;\r\n\t}\r\n\tstatic isEmptyClick(e: MouseEvent) {\r\n\t\ttry {\r\n\t\t\tconst selection = window.getSelection()!;\r\n\t\t\tif (selection.type === 'Range') return false;\r\n\t\t} catch (err) {}\r\n\t\tBattleTooltips.hideTooltip();\r\n\t}\r\n\tstatic posStyle(room: PSRoom) {\r\n\t\tlet pos: PanelPosition | null = null;\r\n\t\tif (PS.leftRoomWidth === 0) {\r\n\t\t\t// one panel visible\r\n\t\t\tif (room === PS.activePanel) pos = {top: 56};\r\n\t\t} else {\r\n\t\t\t// both panels visible\r\n\t\t\tif (room === PS.leftRoom) pos = {top: 56, right: PS.leftRoomWidth};\r\n\t\t\tif (room === PS.rightRoom) pos = {top: 56, left: PS.leftRoomWidth};\r\n\t\t}\r\n\r\n\t\tif (!pos) return {display: 'none'};\r\n\r\n\t\tlet top: number | null = (pos.top || 0);\r\n\t\tlet height: number | null = null;\r\n\t\tlet bottom: number | null = (pos.bottom || 0);\r\n\t\tif (bottom > 0 || top < 0) {\r\n\t\t\theight = bottom - top;\r\n\t\t\tif (height < 0) throw new RangeError(\"Invalid pos range\");\r\n\t\t\tif (top < 0) top = null;\r\n\t\t\telse bottom = null;\r\n\t\t}\r\n\r\n\t\tlet left: number | null = (pos.left || 0);\r\n\t\tlet width: number | null = null;\r\n\t\tlet right: number | null = (pos.right || 0);\r\n\t\tif (right > 0 || left < 0) {\r\n\t\t\twidth = right - left - 1;\r\n\t\t\tif (width < 0) throw new RangeError(\"Invalid pos range\");\r\n\t\t\tif (left < 0) left = null;\r\n\t\t\telse right = null;\r\n\t\t}\r\n\r\n\t\treturn {\r\n\t\t\tdisplay: 'block',\r\n\t\t\ttop: top === null ? `auto` : `${top}px`,\r\n\t\t\theight: height === null ? `auto` : `${height}px`,\r\n\t\t\tbottom: bottom === null ? `auto` : `${-bottom}px`,\r\n\t\t\tleft: left === null ? `auto` : `${left}px`,\r\n\t\t\twidth: width === null ? `auto` : `${width}px`,\r\n\t\t\tright: right === null ? `auto` : `${-right}px`,\r\n\t\t};\r\n\t}\r\n\tstatic getPopupStyle(room: PSRoom, width?: number | 'auto'): any {\r\n\t\tif (room.location === 'modal-popup' || !room.parentElem) {\r\n\t\t\treturn {width: width || 480};\r\n\t\t}\r\n\t\tif (!room.width || !room.height) {\r\n\t\t\treturn {\r\n\t\t\t\tposition: 'absolute',\r\n\t\t\t\tvisibility: 'hidden',\r\n\t\t\t\tmargin: 0,\r\n\t\t\t\ttop: 0,\r\n\t\t\t\tleft: 0,\r\n\t\t\t};\r\n\t\t}\r\n\t\t// nonmodal popup: should be positioned near source element\r\n\t\tlet style: any = {\r\n\t\t\tposition: 'absolute',\r\n\t\t\tmargin: 0,\r\n\t\t};\r\n\t\tlet offset = room.parentElem.getBoundingClientRect();\r\n\t\tlet sourceWidth = offset.width;\r\n\t\tlet sourceHeight = offset.height;\r\n\r\n\t\tlet availableHeight = document.documentElement.clientHeight;\r\n\t\tlet height = room.height;\r\n\t\twidth = width || room.width;\r\n\r\n\t\tif (room.rightPopup) {\r\n\r\n\t\t\tif (availableHeight > offset.top + height + 5 &&\r\n\t\t\t\t(offset.top < availableHeight * 2 / 3 || offset.top + 200 < availableHeight)) {\r\n\t\t\t\tstyle.top = offset.top;\r\n\t\t\t} else if (offset.top + sourceHeight >= height) {\r\n\t\t\t\tstyle.bottom = Math.max(availableHeight - offset.top - sourceHeight, 0);\r\n\t\t\t} else {\r\n\t\t\t\tstyle.top = Math.max(0, availableHeight - height);\r\n\t\t\t}\r\n\t\t\tlet offsetLeft = offset.left + sourceWidth;\r\n\t\t\tif (width !== 'auto' && offsetLeft + width > document.documentElement.clientWidth) {\r\n\t\t\t\tstyle.right = 1;\r\n\t\t\t} else {\r\n\t\t\t\tstyle.left = offsetLeft;\r\n\t\t\t}\r\n\r\n\t\t} else {\r\n\r\n\t\t\tif (availableHeight > offset.top + sourceHeight + height + 5 &&\r\n\t\t\t\t(offset.top + sourceHeight < availableHeight * 2 / 3 || offset.top + sourceHeight + 200 < availableHeight)) {\r\n\t\t\t\tstyle.top = offset.top + sourceHeight;\r\n\t\t\t} else if (height + 5 <= offset.top) {\r\n\t\t\t\tstyle.bottom = Math.max(availableHeight - offset.top, 0);\r\n\t\t\t} else if (height + 10 < availableHeight) {\r\n\t\t\t\tstyle.bottom = 5;\r\n\t\t\t} else {\r\n\t\t\t\tstyle.top = 0;\r\n\t\t\t}\r\n\r\n\t\t\tlet availableWidth = document.documentElement.clientWidth - offset.left;\r\n\t\t\tif (width !== 'auto' && availableWidth < width + 10) {\r\n\t\t\t\tstyle.right = 10;\r\n\t\t\t} else {\r\n\t\t\t\tstyle.left = offset.left;\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\tif (width) style.maxWidth = width;\r\n\r\n\t\treturn style;\r\n\t}\r\n\trenderRoom(room: PSRoom) {\r\n\t\tconst roomType = PS.roomTypes[room.type];\r\n\t\tconst Panel = roomType ? roomType.Component : PSRoomPanel;\r\n\t\treturn <Panel key={room.id} room={room} />;\r\n\t}\r\n\trenderPopup(room: PSRoom) {\r\n\t\tconst roomType = PS.roomTypes[room.type];\r\n\t\tconst Panel = roomType ? roomType.Component : PSRoomPanel;\r\n\t\tif (room.location === 'popup' && room.parentElem) {\r\n\t\t\treturn <Panel key={room.id} room={room} />;\r\n\t\t}\r\n\t\treturn <div key={room.id} class=\"ps-overlay\">\r\n\t\t\t<Panel room={room} />\r\n\t\t</div>;\r\n\t}\r\n\trender() {\r\n\t\tlet rooms = [] as preact.VNode[];\r\n\t\tfor (const roomid in PS.rooms) {\r\n\t\t\tconst room = PS.rooms[roomid]!;\r\n\t\t\tif (room.location === 'left' || room.location === 'right') {\r\n\t\t\t\trooms.push(this.renderRoom(room));\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn <div class=\"ps-frame\">\r\n\t\t\t<PSHeader style={{top: 0, left: 0, right: 0, height: '50px'}} />\r\n\t\t\t{rooms}\r\n\t\t\t{PS.popups.map(roomid => this.renderPopup(PS.rooms[roomid]!))}\r\n\t\t</div>;\r\n\t}\r\n}\r\n\r\ntype PanelPosition = {top?: number, bottom?: number, left?: number, right?: number} | null;\r\n\r\nfunction SanitizedHTML(props: {children: string}) {\r\n\treturn <div dangerouslySetInnerHTML={{__html: BattleLog.sanitizeHTML(props.children)}}/>;\r\n}\r\n"],"file":"panels.js"}